<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Luu Tuan Hoang">
    <meta name="description" content="9.2C">
    <meta name="keywords" content="HTML, Bootstrap, JavaScript, Vue, Vue Router">
    <title>9.2C</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="vue.global.js"></script>
    <script src="vue-router.global.js"></script>
    <!-- HTML5 shiv and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
<div id="app" class="container py-4">
    <router-view></router-view>
</div>
<script>
    const { createApp, reactive, ref } = Vue;
    const { createRouter, createWebHistory } = VueRouter;

    const auth = reactive({
        loggedIn: false,
        username: '',
        password: ''
    });

    const LoginComponent = {
        template: `
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Login</h2>
                    <form @submit.prevent="login">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" v-model="username" placeholder="Enter your username">
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" v-model="password" placeholder="Enter your password">
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        `,
        setup() {
            const username = ref('');
            const password = ref('');

            const login = () => {
                axios.post('/api/login', { username: username.value, password: password.value })
                    .then(response => {
                        if (response.data.success) {
                            auth.loggedIn = true;
                            auth.username = username.value;
                            router.push('/view');
                        } else {
                            alert('Invalid login');
                        }
                    })
                    .catch(error => {
                        console.error('Error during login:', error);
                        alert('Error during login');
                    });
            };

            return { username, password, login };
        }
    };

    const Navigation = {
        template: `
            <div class="btn-group">
                <button @click="logout" class="btn btn-danger">Logout</button>
                <button @click="navigate('view')" class="btn btn-info">View Units</button>
                <button @click="navigate('insert')" class="btn btn-success">Insert Unit</button>
                <button @click="navigate('update')" class="btn btn-warning">Update Unit</button>
                <button @click="navigate('delete')" class="btn btn-danger">Delete Unit</button>
            </div>
        `,
        setup() {
            const logout = () => {
                auth.loggedIn = false;
                auth.username = '';
                auth.password = '';
                router.push('/login');
            };

            const navigate = (path) => {
                router.push(`/${path}`);
            };

            return { logout, navigate };
        }
    };

    const InsertComponent = {
        template: `
        <div class="card">
            <Navigation></Navigation>
        </div>
        <div id="content">
            <div class="card-body">
                <h3 class="card-title">Insert Unit</h3>
                <form @submit.prevent="insertUnit">
                    <div class="mb-3">
                        <label for="code" class="form-label">Code</label>
                        <input type="text" class="form-control" id="code" v-model="newUnit.code" placeholder="Enter unit code">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" v-model="newUnit.description" placeholder="Enter unit description">
                    </div>
                    <div class="mb-3">
                        <label for="cp" class="form-label">CP</label>
                        <input type="text" class="form-control" id="cp" v-model="newUnit.cp" placeholder="Enter unit CP">
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <input type="text" class="form-control" id="type" v-model="newUnit.type" placeholder="Enter unit type">
                    </div>
                    <button type="submit" class="btn btn-primary">Insert Unit</button>
                </form>
            </div>
        </div>
    `,
        setup() {
            const newUnit = Vue.ref({
                code: '',
                description: '',
                cp: '',
                type: ''
            });

            const insertUnit = () => {
                axios.post('/api/units', newUnit.value)
                    .then(response => {
                        if (response.data.success) {
                            alert('Unit inserted!');
                            router.push('/view');
                        }
                    })
                    .catch(error => {
                        console.error('Error inserting unit:', error);
                    });
            };
            return { newUnit, insertUnit};
        },
        components: {
            Navigation
        }
    };

    const ViewComponent = {
        template: `
        <div class="card">
            <Navigation></Navigation>
        </div>
        <div id="content">
            <div class="card-body">
                <h3 class="card-title">View Units</h3>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Description</th>
                            <th>CP</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="unit in paginatedUnits" :key="unit.code">
                            <td>{{ unit.code }}</td>
                            <td>{{ unit.description }}</td>
                            <td>{{ unit.cp }}</td>
                            <td>{{ unit.type }}</td>
                        </tr>
                    </tbody>
                </table>
                <nav>
                    <ul class="pagination">
                        <li class="page-item" :class="{ disabled: currentPage === 1 }">
                            <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
                        </li>
                        <li class="page-item" v-for="page in totalPages" :key="page" :class="{ active: currentPage === page }">
                            <a class="page-link" href="#" @click.prevent="changePage(page)">{{ page }}</a>
                        </li>
                        <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                            <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    `,
        setup() {
            const units = Vue.ref([]);
            const currentPage = Vue.ref(1);
            const itemsPerPage = 10;

            const fetchUnits = () => {
                axios.get('/api/units')
                    .then(response => {
                        units.value = response.data;
                    })
                    .catch(error => {
                        console.error('Error fetching units:', error);
                    });
            };

            const paginatedUnits = Vue.computed(() => {
                const start = (currentPage.value - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return units.value.slice(start, end);
            });

            const totalPages = Vue.computed(() => {
                return Math.ceil(units.value.length / itemsPerPage);
            });

            const changePage = (page) => {
                if (page > 0 && page <= totalPages.value) {
                    currentPage.value = page;
                }
            };

            Vue.onMounted(fetchUnits);

            return { units, paginatedUnits, currentPage, totalPages, changePage };
        },
        components: {
            Navigation
        }
    };

    const UpdateComponent = {
        template: `
        <div class="card">
            <Navigation></Navigation>
        </div>
        <div id="content">
            <div class="card-body">
                <h3 class="card-title">Update Unit</h3>
                <form @submit.prevent="updateUnit">
                    <div class="mb-3">
                        <label for="code" class="form-label">Code</label>
                        <input type="text" class="form-control" id="code" v-model="unit.code" placeholder="Enter unit code">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" v-model="unit.description" placeholder="Enter unit description">
                    </div>
                    <div class="mb-3">
                        <label for="cp" class="form-label">CP</label>
                        <input type="text" class="form-control" id="cp" v-model="unit.cp" placeholder="Enter unit CP">
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <input type="text" class="form-control" id="type" v-model="unit.type" placeholder="Enter unit type">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Unit</button>
                </form>
            </div>
        </div>
    `,
        setup() {
            const unit = Vue.reactive({
                code: '',
                description: '',
                cp: '',
                type: ''
            });

            const updateUnit = () => {
                axios.put(`/api/units/${unit.code}`, unit)
                    .then(response => {
                        if (response.data.success) {
                            alert('Unit updated!');
                            router.push('/view');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating unit:', error);
                        alert('Failed to update unit. Please try again.');
                    });
            };

            Vue.onMounted(() => {
                const { code } = router.currentRoute.value.params;
                axios.get(`/api/units/${code}`)
                    .then(response => {
                        const { code, description, cp, type } = response.data;
                        unit.code = code;
                        unit.description = description;
                        unit.cp = cp;
                        unit.type = type;
                    })
                    .catch(error => {
                        console.error('Error fetching unit details:', error);
                    });
            });

            return { unit, updateUnit };
        },
        components: {
            Navigation
        }
    };

    const DeleteComponent = {
        template: `
        <div class="card">
            <Navigation></Navigation>
        </div>
        <div id="content">
            <div class="card-body">
                <h3 class="card-title">Delete Unit</h3>
                <form @submit.prevent="deleteUnit">
                    <div class="mb-3">
                        <label for="code" class="form-label">Code</label>
                        <input type="text" class="form-control" id="code" v-model="unitCode" placeholder="Enter unit code">
                    </div>
                    <button type="submit" class="btn btn-danger">Delete Unit</button>
                </form>
            </div>
        </div>
    `,
        setup() {
            const unitCode = ref('');

            const deleteUnit = () => {
                axios.delete(`/api/units/${unitCode.value}`)
                    .then(response => {
                        if (response.data.success) {
                            alert('Unit deleted!');
                            router.push('/view'); // Redirect to view units after deletion
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting unit:', error);
                        alert('Error deleting unit');
                    });
            };

            return { unitCode, deleteUnit };
        },
        components: {
            Navigation
        }
    };

    const router = createRouter({
        history: createWebHistory(),
        routes: [
            { path: '/', redirect: '/login' },
            { path: '/login', component: LoginComponent },
            { path: '/view', component: ViewComponent, meta: { requiresAuth: true } },
            { path: '/insert', component: InsertComponent, meta: { requiresAuth: true } },
            { path: '/update', component: UpdateComponent, meta: { requiresAuth: true } },
            { path: '/delete', component: DeleteComponent, meta: { requiresAuth: true } }
        ]
    });

    const app = createApp({});
    app.use(router);
    app.mount('#app');
</script>
</body>
</html>